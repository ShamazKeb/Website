<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Töpfern in Bilk</title>
  <link rel="icon" href="../css/img/logohell.png" type="image/x-icon" />
  <link rel="stylesheet" href="../css/style.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Quicksand&family=Dancing+Script&display=swap"
    rel="stylesheet" />
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--color-accent);
    }

    .admin-header h1 {
      color: var(--color-text);
      margin: 0;
    }

    .admin-nav {
      display: flex;
      gap: 15px;
    }

    .admin-nav button {
      background: var(--color-accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .admin-nav button:hover {
      background: #d4894a;
    }

    .admin-nav button.logout {
      background: #dc3545;
    }

    .admin-nav button.logout:hover {
      background: #c82333;
    }

    .admin-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .admin-section {
      background: var(--color-white);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .admin-section h2 {
      color: var(--color-text);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }

    .review-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid var(--color-accent);
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .reviewer-name {
      font-weight: 600;
      color: var(--color-text);
    }

    .review-date {
      color: #666;
      font-size: 12px;
    }

    .review-stars {
      color: #ffd700;
      margin-bottom: 10px;
    }

    .review-text {
      color: var(--color-text);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .review-actions {
      display: flex;
      gap: 10px;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-delete:hover {
      background: #c82333;
    }

    .content-editor {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .content-editor h3 {
      color: var(--color-text);
      margin-bottom: 10px;
      font-size: 16px;
    }

    .content-editor textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }

    .content-editor button {
      background: var(--color-accent);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
    }

    .content-editor button:hover {
      background: #d4894a;
    }

    .success {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--color-text);
    }

    @media (max-width: 768px) {
      .admin-content {
        grid-template-columns: 1fr;
      }

      .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <div class="admin-nav">
        <button onclick="window.open('../index.html', '_blank')">Website anzeigen</button>
        <button onclick="refreshReviews()">Bewertungen aktualisieren</button>
        <button class="logout" onclick="logout()">Abmelden</button>
      </div>
    </div>

    <div id="message"></div>

    <div class="admin-content">
      <!-- Reviews Management -->
      <div class="admin-section">
        <h2>Bewertungen verwalten</h2>
        <div id="reviewsList">
          <div class="loading">Lade Bewertungen...</div>
        </div>
      </div>

      <!-- Content Editor -->
      <div class="admin-section">
        <h2>Website-Inhalte bearbeiten</h2>

        <div class="content-editor">
          <h3>Hero-Titel (Hauptseite)</h3>
          <textarea id="heroTitle" placeholder="Haupttitel der Startseite...">Guiding into higher Frequencies</textarea>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="saveContent('heroTitle', 'index.html')">Speichern</button>
            <button onclick="refreshWebsite()" style="background: #28a745;">Website aktualisieren</button>
          </div>
        </div>

        <div class="content-editor">
          <h3>Hero-Untertitel</h3>
          <textarea id="heroSubtitle" placeholder="Untertitel der Startseite...">& Cranio-Sacrale Balance</textarea>
          <button onclick="saveContent('heroSubtitle', 'index.html')">Speichern</button>
        </div>

        <div class="content-editor">
          <h3>Über mich Text</h3>
          <textarea id="aboutText" placeholder="Text im 'Über mich' Bereich...">Ich möchte gar nicht viel über mich sprechen, da es hier um Dich geht.
Du bist hier auf dieser Seite gelandet, weil ein Teil in Dir entschieden hat eine tiefere Verbindung mit Dir einzugehen.
Ich bin ausgebildete Physiotherapeutin und bin es schon lange nicht mehr.
Wir sind so viel mehr als unser physischer Körper!

Der Körper mit all seinen Signalen oder Symptomen gibt uns wunderbare Hinweise und kann als Einstieg genutzt werden zu dem,
 was es wirklich gilt zu erkennen, anzunehmen, loszulassen oder zu verändern.

Durch viele Methoden und Techniken im Physischen wie im Energetischen, 
durch Begegnungen mit großen und kleinen Lehrern durfte ich mich stetig weiterentwickelt.
Meine größte Ausbildung jedoch ist das Leben selbst.</textarea>
          <button onclick="saveContent('aboutText', 'index.html')">Speichern</button>
        </div>

        <div class="content-editor">
          <h3>Cranio-Sacrale Text</h3>
          <textarea id="cranioText" placeholder="Text im Cranio-Sacrale Bereich...">Cranio ist eine sanfte Methode zur Entspannung des Nervensystems und lädt dazu ein, 
 tiefer in die eigene Mitte einzutauchen.</textarea>
          <button onclick="saveContent('cranioText', 'index.html')">Speichern</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Check authentication
    const token = localStorage.getItem('authToken');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Logout
    function logout() {
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
    }

    // Helper functions
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div class="${type}">${text}</div>`;
      setTimeout(() => messageDiv.innerHTML = '', 3000);
    }

    async function fetchWithAuth(url, options = {}) {
      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
      const response = await fetch(url, { ...options, headers });
      if (response.status === 401 || response.status === 403) {
        logout(); // Token invalid/expired
        return null;
      }
      return response;
    }

    // Load reviews
    async function loadReviews() {
      const reviewsList = document.getElementById('reviewsList');
      reviewsList.innerHTML = '<div class="loading">Lade Bewertungen...</div>';

      try {
        const response = await fetchWithAuth('/api/admin/reviews');
        if (!response) return; // Auth error handled in fetchWithAuth

        const reviews = await response.json();

        if (!reviews || reviews.length === 0) {
          reviewsList.innerHTML = '<p>Keine Bewertungen vorhanden.</p>';
          return;
        }

        const reviewsHTML = reviews.map(review => `
  <div class="review-item" data-review-id="${review.id}"
    style="${review.approved ? 'border-left-color: #28a745;' : 'border-left-color: #ffc107;'}">
    <div class="review-header">
      <span class="reviewer-name">${review.name}</span>
      <span class="review-date">${new Date(review.date).toLocaleDateString('de-DE')}</span>
    </div>
    <div class="review-stars">
      ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
    </div>
    <div class="review-text">${review.content}</div>
    <div style="margin-top: 5px; font-size: 0.8em; color: #666;">
      Status: <strong>${review.approved ? 'Öffentlich' : 'Wartet auf Freigabe'}</strong>
    </div>
    <div class="review-actions" style="margin-top: 10px;">
      ${!review.approved ? `<button onclick="approveReview(${review.id})"
        style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Freigeben</button>`
            : ''}
      <button class="btn-delete" onclick="deleteReview(${review.id})">Löschen</button>
    </div>
  </div>
  `).join('');

        reviewsList.innerHTML = reviewsHTML;

      } catch (error) {
        console.error('Error loading reviews:', error);
        reviewsList.innerHTML = '<div class="error">Fehler beim Laden der Bewertungen.</div>';
      }
    }

    // Approve Review
    async function approveReview(id) {
      if (!confirm('Soll diese Bewertung öffentlich angezeigt werden?')) return;

      try {
        const response = await fetchWithAuth(`/api/admin/reviews/${id}/approve`, { method: 'PUT' });
        if (response && response.ok) {
          showMessage('Bewertung freigegeben!', 'success');
          loadReviews();
        } else {
          showMessage('Fehler beim Freigeben.', 'error');
        }
      } catch (err) {
        showMessage('Kommunikationsfehler.', 'error');
      }
    }

    // Delete review
    async function deleteReview(reviewId) {
      if (!confirm('Sind Sie sicher, dass Sie diese Bewertung löschen möchten?')) return;

      try {
        const response = await fetchWithAuth(`/api/admin/reviews/${reviewId}`, { method: 'DELETE' });

        if (response && response.ok) {
          showMessage('Bewertung gelöscht', 'success');
          // Remove from DOM
          const el = document.querySelector(`[data-review-id="${reviewId}"]`);
          if (el) el.remove();
        } else {
          showMessage('Fehler beim Löschen.', 'error');
        }
      } catch (error) {
        console.error('Unexpected error:', error);
        showMessage(`Fehler: ${error.message}`, 'error');
      }
    }

    // Load reviews on page load
    // Load reviews and content on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadReviews();
      loadContent();
    });

    function refreshReviews() {
      loadReviews();
    }

    function refreshWebsite() {
      window.open('../index.html', '_blank');
    }

    async function loadContent() {
      try {
        const response = await fetch('/api/content');
        if (!response.ok) return;
        const content = await response.json();

        // Populate textareas
        const fields = ['heroTitle', 'heroSubtitle', 'aboutText', 'cranioText'];
        fields.forEach(field => {
          if (content[field] && document.getElementById(field)) {
            document.getElementById(field).value = content[field];
          }
        });
      } catch (error) {
        console.error('Error loading content:', error);
      }
    }

    async function saveContent(key, context) {
      const textarea = document.getElementById(key);
      if (!textarea) return;

      const value = textarea.value;

      try {
        const response = await fetchWithAuth(`/api/admin/content/${key}`, {
          method: 'PUT',
          body: JSON.stringify({ value })
        });

        if (response && response.ok) {
          showMessage('Inhalt gespeichert!', 'success');
        } else {
          showMessage('Fehler beim Speichern.', 'error');
        }
      } catch (err) {
        console.error(err);
        showMessage('Kommunikationsfehler.', 'error');
      }
    }
  </script>
</body>

</html>